<!DOCTYPE html>
<html lang="en" ng-app="todoApp">
<head>
  <title>Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <!--style -->
</head>
<body ng-controller="TodoController">
<div class="ht-top">
<div class="container">
      <div class="logo col-sm-9"> <img src="logo.jpg"></div>
      <div class="text-right col-sm-3"><ul class=""><li><a><i class="fas fa-user-circle"></i> NAME</a></li><li><a><i class="fas fa-briefcase"></i></a></li><li><a><i class="fas fa-cog"></i></a></li></ul></div>
  </div>
</div>
  <section class="tool-sct">
    <div class="container">
      <div class="row slider_container" >
        <div class="col-sm-6">
          <div class="w3-light-grey w3-tiny">
            <div class="slidecontainer">
              <input type="range" min="1" max="10" value="10" class="slider" ng-model="filters.transaction" id="myRange1" ng-change="filterMap();">
              <i class="tooltipTag" data-toggle="tooltip" title="About Transaction score">?</i>
              <div class="sliderlabel">
                <label>0</label>
                <label>1</label>
                <label>2</label>
                <label>3</label>
                <label>4</label>
                <label>5</label>
                <label>6</label>
                <label>7</label>
                <label>8</label>
                <label>9</label>
                <label>10</label>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="w3-light-grey w3-tiny">
          <div class="slidecontainer">
              <input type="range" min="1" max="10" value="10" class="slider" ng-model="filters.member" id="myRange2" ng-change="filterMap();">
              <i class="tooltipTag" data-toggle="tooltip" title="About Member score">?</i>
              <div class="sliderlabel">
                <label>0</label>
                <label>1</label>
                <label>2</label>
                <label>3</label>
                <label>4</label>
                <label>5</label>
                <label>6</label>
                <label>7</label>
                <label>8</label>
                <label>9</label>
                <label>10</label>
              </div>
            </div>
       </div>
      </div>
      </div>        
      <div class="row map-container">
          <div class="map">
            <div id="googleMap" style="width:100%;height:400px;"></div>           
          </div>
          <div class="map-detail">
           <h5 class="topcoutryhead">Top 5 Countries</h5>
           <table class="table table-bordered">
              <tr>
                <td width="20%">Transaction Score <i class="tooltipTag" data-toggle="tooltip" title="About Transaction score">?</i></td>
                <td width="80%">
                  <div ng-repeat="tr in topTransaction track by $index" ng-if="$index < 5">{{tr}}</div>
                </td>
              </tr>
              <tr>
                <td>Member Score <i class="tooltipTag" data-toggle="tooltip" title="About Transaction score">?</i></td>
                <td>
                  <div ng-repeat="tr in topMember track by $index" ng-if="$index < 5">{{tr}}</div>
              </tr>
            </table>
           </div>
      </div>
    </div>
  </section>

<div ng-repeat="wind in selectedWindow" class="info-window" draggable>
	<i class="fas fa-times close-btn" ng-click="removeSelected($index);"></i>
	<div class="row">
		<div class="col-sm-6 heading" >
			<div>
				<span>{{wind.ind.MAINADDRESS_COUNTRY}}</span>
				<span>{{wind.selType == 'TRANSACTION_DATA' ? 'Transaction Score' : 'Member Score'}}</span>
			</div>
		</div>
		<div class="col-sm-6 threemonth scoretiles" ng-class="{green_color: wind.ind[wind.selType].FIVEMIN < 100, amber_color: wind.ind[wind.selType].FIVEMIN>= 100 && wind.ind[wind.selType].FIVEMIN < 500, red_color: wind.ind[wind.selType].FIVEMIN>= 500}">
			<div><span>{{wind.ind[wind.selType].FIVEMIN}}</span><span>5 min</span></div>
		</div>
		<div class="col-sm-6 fivemin scoretiles" ng-class="{green_color: wind.ind[wind.selType].ONEDAY < 100, amber_color: wind.ind[wind.selType].ONEDAY>= 100 && wind.ind[wind.selType].ONEDAY < 500, red_color: wind.ind[wind.selType].ONEDAY>= 500}">
			<div><span>{{wind.ind[wind.selType].ONEDAY}}</span><span>1 day</span></div>
		</div>
		<div class="col-sm-6 oneday scoretiles" ng-class="{green_color: wind.ind[wind.selType].ONEWEEK < 100, amber_color: wind.ind[wind.selType].ONEWEEK>= 100 && wind.ind[wind.selType].ONEWEEK < 500, red_color: wind.ind[wind.selType].ONEWEEK>= 500}">
			<div><span>{{wind.ind[wind.selType].ONEWEEK}}</span><span>1 week</span></div>
		</div>
		<div class="col-sm-6 oneweek scoretiles" ng-class="{green_color: wind.ind[wind.selType].ONEMONTH < 100, amber_color: wind.ind[wind.selType].ONEMONTH>= 100 && wind.ind[wind.selType].ONEMONTH < 500, red_color: wind.ind[wind.selType].ONEMONTH>= 500}">
			<div><span>{{wind.ind[wind.selType].ONEMONTH}}</span><span>1 month</span></div>
		</div>
		<div class="col-sm-6 onemonth scoretiles" ng-class="{green_color: wind.ind[wind.selType].THREEMONTH < 100, amber_color: wind.ind[wind.selType].THREEMONTH>= 100 && wind.ind[wind.selType].THREEMONTH < 500, red_color: wind.ind[wind.selType].THREEMONTH>= 500}">
			<div><span>{{wind.ind[wind.selType].THREEMONTH}}</span><span>3 months</span></div>
		</div>
	</div>
</div>


<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">{{selectedData.ind.MAINADDRESS_COUNTRY}} - {{selectedData.selType == 'TRANSACTION_DATA' ? 'Transaction Score' : 'Member Score'}}</h4>
      </div>
      <div class="modal-body">
        <div class="morebubbledetails" ng-if="selectedData.ind.MAINADDRESS_COUNTRY">
            <div class="crossLines crossLine1"></div>
            <div class="crossLines crossLine2"></div>
            <div class="bubble bubble0" ng-class="{greenbubble: selectedData.ind[selectedData.selType].ONEDAY < 100, amberbubble: selectedData.ind[selectedData.selType].ONEDAY>= 100 && selectedData.ind[selectedData.selType].ONEDAY < 500, redbubble: selectedData.ind[selectedData.selType].ONEDAY>= 500}">
              <div><span>{{selectedData.ind[selectedData.selType].ONEDAY}}</span><span>1 day</span></div>
            </div>
            <div class="bubble bubble1" ng-class="{greenbubble: selectedData.ind[selectedData.selType].ONEMONTH < 100, amberbubble: selectedData.ind[selectedData.selType].ONEMONTH>= 100 && selectedData.ind[selectedData.selType].ONEMONTH < 500, redbubble: selectedData.ind[selectedData.selType].ONEMONTH>= 500}">
              <div><span>{{selectedData.ind[selectedData.selType].ONEMONTH}}</span><span>1 week</span></div>
            </div>
            <div class="bubble bubble2" ng-class="{greenbubble: selectedData.ind[selectedData.selType].ONEMONTH < 100, amberbubble: selectedData.ind[selectedData.selType].ONEMONTH>= 100 && selectedData.ind[selectedData.selType].ONEMONTH < 500, redbubble: selectedData.ind[selectedData.selType].ONEMONTH>= 500}">
              <div><span>{{selectedData.ind[selectedData.selType].ONEMONTH}}</span><span>1 month</span></div>
            </div>
            <div class="bubble bubble3" ng-class="{greenbubble: selectedData.ind[selectedData.selType].THREEMONTH < 100, amberbubble: selectedData.ind[selectedData.selType].THREEMONTH>= 100 && selectedData.ind[selectedData.selType].THREEMONTH < 500, redbubble: selectedData.ind[selectedData.selType].THREEMONTH>= 500}">
              <div><span>{{selectedData.ind[selectedData.selType].THREEMONTH}}</span><span>3 months</span></div>
            </div>
            <div class="bubble bubble4" ng-class="{greenbubble: selectedData.ind[selectedData.selType].FIVEMIN < 100, amberbubble: selectedData.ind[selectedData.selType].FIVEMIN>= 100 && selectedData.ind[selectedData.selType].FIVEMIN < 500, redbubble: selectedData.ind[selectedData.selType].FIVEMIN>= 500}">
              <div><span>{{selectedData.ind[selectedData.selType].FIVEMIN}}</span><span>5 min</span></div>
            </div>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.8/angular.min.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkGAMLTnhCQfCHuucSQCdoKDaxzfFqEro&sensor=false&libraries=geometry,places&ext=.js"></script>
  <script type="text/javascript" src="js/markerwithlabel.js"></script>
  <script>
    var map;
    angular.module('todoApp', [])
    .directive("draggable", function(){
	    return {
	        restrict: "A",
	        link: function (scope, element, attrs) {
	            $(element).draggable();
	        }
	    };
	})
    .controller('TodoController', function($scope) {
        $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip(); 
        });

          $scope.selectedData = {};
          $scope.markers = [];

          $scope.selectedWindow = [];

          $scope.removeSelected = function(ind){
          	$scope.selectedWindow.splice(ind, 1);
          };

          $scope.mockData = [
                  {
                    "MAINADDRESS_COUNTRY":"North America", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 7, "FIVEMIN":20, "ONEDAY":40, "ONEWEEK": 80, "ONEMONTH": 350, "THREEMONTH": 800, "LATITUDE": 37.588119, "LONGITUDE": -95.370119}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 7, "FIVEMIN":190, "ONEDAY":270, "ONEWEEK": 400, "ONEMONTH": 500, "THREEMONTH": 800, "LATITUDE": 42.948381, "LONGITUDE": -115.049012}
                  },
                  {
                    "MAINADDRESS_COUNTRY":"South Africa", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 9, "FIVEMIN":60, "ONEDAY":140, "ONEWEEK": 250, "ONEMONTH": 500, "THREEMONTH": 600, "LATITUDE": -7.874265, "LONGITUDE": 16.377877}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 7,  "FIVEMIN":35, "ONEDAY":47, "ONEWEEK": 97, "ONEMONTH": 200, "THREEMONTH": 500, "LATITUDE": -8.570158, "LONGITUDE": 32.542681}
                  },
                  {
                    "MAINADDRESS_COUNTRY":"India", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 9,  "FIVEMIN":105, "ONEDAY":170, "ONEWEEK": 240, "ONEMONTH": 500, "THREEMONTH": 800, "LATITUDE": 28.777289, "LONGITUDE": 76.117372}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 7,  "FIVEMIN":600, "ONEDAY":650, "ONEWEEK": 200, "ONEMONTH": 500, "THREEMONTH": 800, "LATITUDE": 14.445319, "LONGITUDE": 78.225824}
                  },
                  {
                    "MAINADDRESS_COUNTRY":"China", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 9, "FIVEMIN":600, "ONEDAY":640, "ONEWEEK": 750, "ONEMONTH": 800, "THREEMONTH": 1600, "LATITUDE": 34.818313, "LONGITUDE": 88.334275}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 9,  "FIVEMIN":300, "ONEDAY":400, "ONEWEEK": 500, "ONEMONTH": 600, "THREEMONTH": 800, "LATITUDE": 30.377614, "LONGITUDE": 100.633583}
                  },
                  {
                    "MAINADDRESS_COUNTRY":"Mexico", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 7, "FIVEMIN":100, "ONEDAY":100, "ONEWEEK": 200, "ONEMONTH": 500, "THREEMONTH": 800, "LATITUDE": 23.634501, "LONGITUDE": -102.552788}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 7, "FIVEMIN":60, "ONEDAY":140, "ONEWEEK": 250, "ONEMONTH": 500, "THREEMONTH": 600, "LATITUDE": 23.110681, "LONGITUDE": -101.143643}
                  },
                  {
                    "MAINADDRESS_COUNTRY":"Canada", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 7,"FIVEMIN":90, "ONEDAY":100, "ONEWEEK": 200, "ONEMONTH": 500, "THREEMONTH": 800, "LATITUDE": 56.130367, "LONGITUDE": -106.346771}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 9, "FIVEMIN":100, "ONEDAY":100, "ONEWEEK": 200, "ONEMONTH": 500, "THREEMONTH": 800, "LATITUDE": 56.078167, "LONGITUDE": -122.842410}
                  },
                  {
                    "MAINADDRESS_COUNTRY":"Italy", 
                    "TRANSACTION_DATA":
                      {"FRAUDSCORE": 7,  "FIVEMIN":300, "ONEDAY":400, "ONEWEEK": 500, "ONEMONTH": 600, "THREEMONTH": 800, "LATITUDE": 41.871941, "LONGITUDE": 12.567380}, 
                    "MEMBER_DATA":
                      {"FRAUDSCORE": 9, "FIVEMIN":600, "ONEDAY":700, "ONEWEEK": 800, "ONEMONTH": 900, "THREEMONTH": 1000, "LATITUDE": 42.452088, "LONGITUDE": 11.983245}
                  }
              ];


          $scope.filters = {transaction: 7, member: 7};

          $scope.filterMap = function(){
            for (var i = 0; i < $scope.markers.length; i++) {
              $scope.markers[i].setMap(null);
            }
            $scope.markers = [];
            $scope.plotMarker();
          };

          $scope.topTransaction = [];
          $scope.topMember = [];

          $scope.plotMarker = function(){
              $scope.topTransaction = [];
              $scope.topMember = [];
              var labelAnchor = new google.maps.Point(7, 45);
              var zoomMap =false;
              var zoomFlag = true;
              if($scope.filters.transaction > 7 || $scope.filters.member > 7){
                var zoomMap = true;
                labelAnchor = new google.maps.Point(7, 65);
              } else {
                map.setCenter(new google.maps.LatLng(38.694085,-1.710901));
                map.setZoom(2);
              }

              angular.forEach($scope.mockData, function(v,i){

                    var labelColor;

                    if($scope.filters.transaction >= 7 && $scope.filters.transaction <= v.TRANSACTION_DATA.FRAUDSCORE){
                        
                        if(zoomMap && zoomFlag){
                            map.setCenter(new google.maps.LatLng(v.TRANSACTION_DATA.LATITUDE, v.TRANSACTION_DATA.LONGITUDE));
                            map.setZoom(5);
                            zoomFlag = false;
                        }

                        $scope.topTransaction.push(v.MAINADDRESS_COUNTRY+' ('+v.TRANSACTION_DATA.FIVEMIN+')');

                        if(v.TRANSACTION_DATA.FIVEMIN >= 500){
                            labelColor = 'red';
                            v.labelClass = "red_color";
                        } else if(v.TRANSACTION_DATA.FIVEMIN >= 100){
                            labelColor = '#ffbf00';
                            v.labelClass = "amber_color";
                        } else{
                            labelColor = 'green';
                            v.labelClass = "green_color";
                        }

                        var marker = new MarkerWithLabel({
                            position: new google.maps.LatLng(v.TRANSACTION_DATA.LATITUDE, v.TRANSACTION_DATA.LONGITUDE),
                            map: map,
                            ind: v,
                            selType: "TRANSACTION_DATA",
                            labelContent: v.TRANSACTION_DATA.FIVEMIN,
                            labelAnchor: labelAnchor,
                            labelClass: "labels", // the CSS class for the label
                            labelInBackground: false,
                            icon: pinSymbol(labelColor, zoomMap ? 2 : 1.3)
                        });

                        $scope.markers.push(marker);

                        google.maps.event.addListener(marker, "click", function (e) {
                            //$("#myModal").modal('show');
                            //$scope.selectedData = this;
                            $scope.selectedWindow.push(this);
                            $scope.$apply();
                        });
                    }

                    var labelColor2;
                    if($scope.filters.member >= 7 && $scope.filters.member <= v.MEMBER_DATA.FRAUDSCORE){
                        
                        if(zoomMap && zoomFlag){
                            map.setCenter(new google.maps.LatLng(v.MEMBER_DATA.LATITUDE, v.MEMBER_DATA.LONGITUDE));
                            map.setZoom(5);
                            zoomFlag = false;
                        }

                        $scope.topMember.push(v.MAINADDRESS_COUNTRY+' ('+v.MEMBER_DATA.FIVEMIN+')');

                        if(v.MEMBER_DATA.FIVEMIN >= 500){
                            labelColor2 = 'red';
                        } else if(v.MEMBER_DATA.FIVEMIN >= 100){
                            labelColor2 = '#ffbf00';
                        } else{
                            labelColor2 = 'green';
                        }

                        var marker2 = new MarkerWithLabel({
                            position: new google.maps.LatLng(v.MEMBER_DATA.LATITUDE, v.MEMBER_DATA.LONGITUDE),
                            map: map,
                            ind: v,
                            selType: "MEMBER_DATA",
                            labelContent: v.MEMBER_DATA.FIVEMIN,
                            labelAnchor: labelAnchor,
                            labelClass: "labels", // the CSS class for the label
                            labelInBackground: false,
                            icon: pinSymbol(labelColor2, zoomMap ? 2 : 1.3)
                        });

                        $scope.markers.push(marker2);

                        google.maps.event.addListener(marker2, "click", function (e) {
                            //$("#myModal").modal('show');

                            //$scope.selectedData = this;
                            $scope.selectedWindow.push(this);
                            $scope.$apply();

                        });
                    }
              });

              $scope.topTransaction.sort(function(a1, b1){
                a = a1.replace("(", "").replace(")", "").split(" ")[1];
                b = b1.replace("(", "").replace(")", "").split(" ")[1];
                return b-a
              });

              $scope.topMember.sort(function(a1, b1){
                a = a1.replace("(", "").replace(")", "").split(" ")[1];
                b = b1.replace("(", "").replace(")", "").split(" ")[1];
                return b-a
              });


              if(!$scope.$$phase) {
                $scope.$apply();
              }
          };


          function initMap() {
              var latLng = new google.maps.LatLng(38.694085,-1.710901);

              map = new google.maps.Map(document.getElementById('googleMap'), {
                  zoom: 2,
                  center: latLng,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
              });

              $scope.plotMarker();
          }

          function log(h) {
              document.getElementById("log").innerHTML += h + "<br />";
          }

          function pinSymbol(color, scale) {
              return {
                  path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
                  fillColor: color,
                  fillOpacity: 1,
                  strokeColor: '#000',
                  strokeWeight: 2,
                  scale: scale
              };
          }
          google.maps.event.addDomListener(window, 'load', initMap);
    });


    </script>
    
  </body>
</html>
